<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>
PIN:
<input type="text" id="user" name="PIN" style="height: 50px; width: 300px;"/>
<button id="connect" onclick="connect()">connect</button>
<br/>
<button onclick="testDeviceOrientation()">Test Device Orientation</button>
<button onclick="reset(0)">reset</button>
<!--<button onclick="reset(1)">resetFront</button>-->
<div class="garden">
    <div class="ball"></div>
</div>

<pre class="output"></pre>

<style>
.garden {
    position: relative;
    width: 200px;
    height: 200px;
    border: 5px solid #CCC;
    border-radius: 10px;
}

.ball {
    position: absolute;
    top: 90px;
    left: 90px;
    width: 20px;
    height: 20px;
    background: green;
    border-radius: 1%;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/js/patternfly.min.js"></script>
<script>
        function connect() {
            location.search = "?user=" + $('#user').val();
        }

        var defaultAngle = {
            a:0,
            b:0,
            g:0
        }
         var currAngle = {
            a:0,
            b:0,
            g:0
        }
        function reset(mode) {
            if(mode === 0) {
                defaultAngle.a = currAngle.a
                defaultAngle.b = currAngle.b
                defaultAngle.g = currAngle.g
            }
        }

        function testDeviceOrientation() {
            if (typeof DeviceOrientationEvent !== 'function') {
                return setResult('DeviceOrientationEvent not detected')
            }
            if (typeof DeviceOrientationEvent.requestPermission !== 'function') {
                return setResult('DeviceOrientationEvent.requestPermission not detected')
            }
            DeviceOrientationEvent.requestPermission().then(function (result) {
                return setResult(result);
            });
        }

        function setResult(result) {
            document.getElementById('result').innerHTML = 'RESULT: ' + result;
        }
        /*
        window.addEventListener("deviceorientation", function(event) {
          // process event.alpha, event.beta and event.gamma
          
          document.write("alpha: " + event.alpha + "beta: " + event.beta + "gamma: " + event.gamma);
      }, true);*/

        var ball = document.querySelector('.ball');
        var garden = document.querySelector('.garden');
        var output = document.querySelector('.output');

        var maxX = garden.clientWidth - ball.clientWidth;
        var maxY = garden.clientHeight - ball.clientHeight;

        var globalX;
        var globalY;
        var globalZ;

        function handleOrientation(event) {
            var z = event.alpha
            var x = event.beta;  // In degree in the range [-180,180]
            var y = event.gamma; // In degree in the range [-90,90]


            output.innerHTML = "alpha : " + z + "\n";
            output.innerHTML += "beta : " + x + "\n";
            output.innerHTML += "gamma: " + y + "\n";

            globalX = x
            globalY = y
            globalZ = z

            // 10 is half the size of the ball
            // It center the positioning point to the center of the ball
            ball.style.top = 180 - (maxY * x / 180 - 10) + "px";
            ball.style.left = 180 - (maxX * z / 180 - 10) + "px";
            if (z > 15) {

            }
            else {
                ball.style.borderRadius = (maxX * y / 180 - 40) + "%";
                // ball.style.width = (10*z) + "px";

<!--                output.innerHTML += (maxX * y / 180 - 40) + "%";-->
            }
        }

        function connectTo(user) {
            const ws = new WebSocket(location.protocol.replace('http', 'ws')+location.host+'/controller/'+user);
            return ws;
        }

        var prevCoord = {x:0, y:0, z:0}
        const diffLevel = 1

      $( document ).ready(function() {
        const params = new URLSearchParams(location.search)
        var user = params.get("user")

        console.log($('#user').value, user)
        if(user != null) {
            $('#user').val(user)
<!--            $('#connect').hide()-->

            let ws = connectTo(user);
            ws.onopen = function (event) {
                 window.addEventListener('deviceorientation', function (orientationEvent) {
                    console.log(orientationEvent)
                    currAngle = {
                        a:orientationEvent.alpha,
                        b:orientationEvent.beta,
                        g:orientationEvent.gamma
                    }
                    const coord = {
                            x: orientationEvent.beta,  // In degree in the range [-180,180],
                            y: orientationEvent.gamma, // In degree in the range [-90,90],
                            z: orientationEvent.alpha
                        }
                    const dx = prevCoord.x - coord.x;
                    const dy = prevCoord.y - coord.y;
                    const dz = prevCoord.z - coord.z;
                    const diff = dx*dx + dy*dy + dz*dz

                    if (diff>diffLevel) {
                        const c = JSON.stringify({
                            x: Math.round((orientationEvent.beta-defaultAngle.b)*10)/10,  // In degree in the range [-180,180],
                            y: Math.round((orientationEvent.gamma-defaultAngle.g)*10)/10, // In degree in the range [-90,90],
                            z: Math.round((orientationEvent.alpha-defaultAngle.a)*10)/10
                        })
                        ws.send(c);
                        prevCoord = coord
                    }
                    handleOrientation(orientationEvent)
                 });
            };
        }
        })

<!--        alert("test js")-->
</script>
</body>

</html>
